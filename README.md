# OnlyEducation

Исходные данные (пример парсера) в папке source. Решение в папке code: 
  - файл миграции для создания ИБ Закупки
  - файл csv
  - парсер

В сделанном парсере изменен алгоритм заполения значения свойств типа "Список". В примере парсера был использован следующий цикл:

      foreach ($arProps[$key] as $propKey => $propVal) {
          if ($key == 'OFFICE') {
              $value = strtolower($value);
              if ($value == 'центральный офис') {
                  $value .= 'свеза ' . $data[2];
              } elseif ($value == 'лесозаготовка') {
                  $value = 'свеза ресурс ' . $value;
              } elseif ($value == 'свеза тюмень') {
                  $value = 'свеза тюмени';
              }
              $arSimilar[similar_text($value, $propKey)] = $propVal;
          }
          if (stripos($propKey, $value) !== false) {
              $value = $propVal;
              break;
          }

          if (similar_text($propKey, $value) > 50) {
              $value = $propVal;
          }
      }
      if ($key == 'OFFICE' && !is_numeric($value)) {
          ksort($arSimilar);
          $value = array_pop($arSimilar);
      }
      
К алгоритму есть замечание:
Для свойства OFFICE предполагается формирование массива со значениями, которые схожи с $value, затем должно выбираться наиболее похожее путём сортировки массива $arSimilar. Однако, если нам попадается $propKey, схожая с $value более, чем на 50 символов (вероятно, предполагалось процентов), то в результате выполнения 

          if (similar_text($propKey, $value) > 50) {
              $value = $propVal;
          }
          
в $value запишется ID этого значения и в следующих итерациях цикла сравнение будет производиться не с первоначальным $value из файла csv, а с записанным ID. Получается фактически алгоритм не работает, присваивается первое значение, которое совпадает, более чем на 50 символов (вероятно, предполагалось процентов).

Если предполагалось, что при совпадении более, чем на 50 символов (вероятно, предполагалось процентов) следует считать, что значения совпадают, тогда нужно добавить break; в условную конструкцию if (similar_text($propKey, $value) > 50) ...

Аналогично для свойств, кроме OFFICE, необходимо добавить break;, иначе после найденного схожего значения продолжатся ненужные итерации цикла.

И предполагаю, что нужно было использовать не сравнение по количеству символов, а по процентному совпадению:

          similar_text($propKey, $value, $similar);
          if ($similar > 50) {
              $arSimilar[$similar] = $propVal;
          }

иначе при короткой строчке (менее 25 символов) условие никогда не выполнимо.

В предложенном мной парсере массив схожих значений формируется для каждого свойства и отыскивается наиболее похожее. Если степень схожести менее 75% значение в массив не попадает.
 
